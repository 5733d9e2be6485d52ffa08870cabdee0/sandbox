name: Labels Cleanup and Check
on:
  pull_request_target:
    types: [opened, labeled, unlabeled, synchronize]
    branches:
      - main
    paths-ignore:
      # keep in sync with Manager-CI.yaml
      - 'LICENSE'
      - '**/.gitignore'
      - '**.md'
      - '**.adoc'
      - '*.txt'
      - '.github/**'
      - 'kustomize/**'
      - 'dev/**'
      - 'app-interface/**'
jobs:
  labels:
    concurrency:
      group: event-bridge-label-pr-${{ github.head_ref }}
      cancel-in-progress: true
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-latest
    steps:
      - name: Remove labels at new commits
        uses: actions/labeler@v4
        if: github.event.action == 'synchronize'
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          sync-labels: true
      - name: "Fail if 'safe to test' label is not present or if there are new commits"
        if: github.event.action == 'synchronize' || github.event.action == 'opened'
        run: |
          echo "You pushed a new commit. Please add the label 'safe to test'."
          exit 1
      - name: "'safe to test' label must be added on the pull request"
        if: (github.event.action == 'labeled' || github.event.action == 'unlabeled') && contains( github.event.pull_request.labels.*.name, 'safe to test')
        run: |
          echo "'safe to test' label is triggering additional pipelines properly"

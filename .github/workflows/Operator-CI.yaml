name: Shard Operator - CI
on:
  pull_request_target:
    types: [ opened, labeled, unlabeled, synchronize ]
    paths:
      - '.github/workflows/Operator-CI.yaml'
      - 'shard-operator/**'
      - 'integration-tests/shard-operator-integration-tests/**'
jobs:
  start-runner:
    name: Start self-hosted EC2 runner
    runs-on: ubuntu-latest
    outputs:
      label: ${{ steps.start-ec2-runner.outputs.label }}
      ec2-instance-id: ${{ steps.start-ec2-runner.outputs.ec2-instance-id }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.KSUTA_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.KSUTA_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.KSUTA_AWS_REGION }}
      - name: Start EC2 runner
        id: start-ec2-runner
        uses: machulav/ec2-github-runner@v2
        with:
          mode: start
          github-token: ${{ secrets.KSUTA_GH_PERSONAL_ACCESS_TOKEN }}
          ec2-image-id: ami-00d8c164663b5a374
          ec2-instance-type: t3.xlarge
          subnet-id: subnet-30717c3e
          security-group-id: sg-0dc576a4c740c8ba9
  event-bridge-build:
    needs: start-runner # required to start the main job when the runner is ready
    runs-on: ${{ needs.start-runner.outputs.label }} # run the job on the newly created runner
    env:
      NAMESPACE: mynamespace
      # This hostname will be used as hostname for the ingress in Kind and is set in the hosts file of the machine
      KIND_MAIN_NODE_HOSTNAME: kind-control-plane
    concurrency:
      group: event-bridge-operator-pr-${{ github.head_ref }}
      cancel-in-progress: true
    timeout-minutes: 45
    name: Build and Test Operator
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          ref: "refs/pull/${{ github.event.number }}/merge"
      - name: Check labels
        # Security due to https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
        if: ${{ !contains( github.event.pull_request.labels.*.name, 'safe to test') }}
        run: |
          echo "Please add the 'safe to test' label in order to run 'Operator - CI' pipeline if it's safe to test this code"
          exit 1
      - name: Java and Maven Setup
        uses: ./.github/actions/java-maven-setup
        with:
          cache-key-prefix: ${{ runner.os }}
      - name: Re-Checkout  # since Java And Maven Setup step is checking out the main branch, we have to checkout the pull request branch again
        uses: actions/checkout@v3
        with:
          ref: "refs/pull/${{ github.event.number }}/merge"
      - name: Set up KinD
        uses: ./.github/actions/kind
        with:
          kind-node-hostname: ${{ env.KIND_MAIN_NODE_HOSTNAME }}
        # Tests are executed in different PR check, we just need all artifacts in repository
      - name: Build complete repo
        uses: ./.github/actions/maven
        with:
          maven-command: clean install --no-snapshot-updates --fail-at-end --errors --quiet -Dquickly
        # Build operator image and generate needed operator resources
      - name: Build Shard operator image and resources
        uses: ./.github/actions/maven
        with:
          maven-command: clean install --errors --quiet -Dquarkus.container-image.build=true -Dquarkus.container-image.tag=$GITHUB_SHA -Dquarkus.kubernetes.image-pull-policy=if-not-present -Dquickly -Dquarkus.kubernetes.namespace=$NAMESPACE
          working-directory: shard-operator
        # Load built image into KinD
      - name: Load Shard operator image into KinD
        run: |
          # KinD needs a specific version to skip external image pull, in case of default 'latest' version KinD would try to fetch the image from external location
          kind load docker-image openbridge/shard-operator:$GITHUB_SHA
      - name: Istio Setup
        uses: ./.github/actions/istio-setup
      - name: Install Knative resources and Prometheus ServiceMonitor CRD
        run: |
          chmod +x dev/bin/knative-installer.sh
          ./dev/bin/knative-installer.sh

          # Add Prometheus ServiceMonitor CRD to avoid BridgeIngress Condition Ready: False Type: PrometheusUnavailable
          kubectl apply -f https://raw.githubusercontent.com/prometheus-operator/kube-prometheus/v0.9.0/manifests/setup/prometheus-operator-0servicemonitorCustomResourceDefinition.yaml
      - name: Install Camel K
        run: |
          chmod +x dev/bin/camel-k-installer.sh
          ./dev/bin/camel-k-installer.sh --registry kind-registry:5000 --kube-config $GITHUB_WORKSPACE/.kube/config
      - name: Deploy Shard operator
        env:
          DEV_EVENT_BRIDGE_SSO_CLIENT_ID: ${{ secrets.DEV_EVENT_BRIDGE_SSO_CLIENT_ID }}
          DEV_EVENT_BRIDGE_SSO_SECRET: ${{ secrets.DEV_EVENT_BRIDGE_SSO_SECRET }}
        run: |
          kubectl create namespace $NAMESPACE
          # Create addon-smart-events-operator-parameters secret
          kubectl create secret generic addon-smart-events-operator-parameters \
          --from-literal=EVENT_BRIDGE_SSO_URL=https://sso.redhat.com/auth/realms/redhat-external \
          --from-literal=EVENT_BRIDGE_SSO_CLIENT_ID=$DEV_EVENT_BRIDGE_SSO_CLIENT_ID \
          --from-literal=EVENT_BRIDGE_SSO_SECRET=$DEV_EVENT_BRIDGE_SSO_SECRET \
          -n $NAMESPACE
          # Deploy operator
          kubectl apply -f shard-operator/target/kubernetes/bridgeexecutors.com.redhat.service.bridge-v1.yml
          kubectl apply -f shard-operator/target/kubernetes/bridgeingresses.com.redhat.service.bridge-v1.yml
          kubectl apply -f shard-operator/target/kubernetes/kubernetes.yml          
          kubectl set env deployment/shard-operator EVENT_BRIDGE_EXECUTOR_IMAGE=quay.io/5733d9e2be6485d52ffa08870cabdee0/empty-it-image:1.0 -n $NAMESPACE
          kubectl wait --for=condition=available --timeout=120s deployment/shard-operator -n $NAMESPACE
      - name: Run integration tests
        env:
          IT_SHARD_KAFKA_BOOTSTRAP_SERVERS: ${{ secrets.IT_SHARD_KAFKA_BOOTSTRAP_SERVERS }}
          IT_SHARD_KAFKA_USER: ${{ secrets.IT_SHARD_KAFKA_USER }}
          IT_SHARD_KAFKA_PASSWORD: ${{ secrets.IT_SHARD_KAFKA_PASSWORD }}
          IT_SHARD_KAFKA_TOPIC_NAME: ${{ secrets.IT_SHARD_KAFKA_TOPIC_NAME }}
        uses: ./.github/actions/maven
        with:
          maven-command: clean verify -Pcucumber -Dparallel -Dit.shard.kafka.bootstrap.servers=$IT_SHARD_KAFKA_BOOTSTRAP_SERVERS -Dit.shard.kafka.user=$IT_SHARD_KAFKA_USER -Dit.shard.kafka.password=$IT_SHARD_KAFKA_PASSWORD -Dit.shard.kafka.topic.name=$IT_SHARD_KAFKA_TOPIC_NAME -Dit.shard.kafka.protocol=SASL_SSL -Dit.shard.kafka.sasl.mechanism=PLAIN -Dkubeconfig=$GITHUB_WORKSPACE/.kube/config
          working-directory: integration-tests/shard-operator-integration-tests
      - name: Archive test logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: cucumber-logs
          path: integration-tests/shard-operator-integration-tests/target/logs/**/*.*
      - name: Print operator log
        if: always()
        run: |
          kubectl logs deployment/shard-operator -n $NAMESPACE
  stop-runner:
    name: Stop self-hosted EC2 runner
    needs:
      - start-runner # required to get output from the start-runner job
      - event-bridge-build # required to wait when the main job is done
    runs-on: ubuntu-latest
    if: ${{ always() }} # required to stop the runner even if the error happened in the previous jobs
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.KSUTA_AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.KSUTA_AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.KSUTA_AWS_REGION }}
      - name: Stop EC2 runner
        uses: machulav/ec2-github-runner@v2
        with:
          mode: stop
          github-token: ${{ secrets.KSUTA_GH_PERSONAL_ACCESS_TOKEN }}
          label: ${{ needs.start-runner.outputs.label }}
          ec2-instance-id: ${{ needs.start-runner.outputs.ec2-instance-id }}
